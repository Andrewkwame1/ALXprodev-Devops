#!/bin/bash

# Task 3: Summarize Pokémon Data
# Objective: Create a report that summarizes data for multiple Pokémon

DATA_DIR="pokemon_data"
REPORT_FILE="pokemon_report.csv"

# Check if data directory exists
if [ ! -d "$DATA_DIR" ]; then
    echo "Error: $DATA_DIR not found. Please run Task 2 first."
    exit 1
fi

# Initialize CSV file with header
echo "Name,Height (m),Weight (kg)" > "$REPORT_FILE"

# Process each JSON file and append rows to the CSV
for json_file in "$DATA_DIR"/*.json; do
    if [ -f "$json_file" ]; then
        name=$(jq -r '.name' "$json_file" | sed 's/.*/\u&/')
        height=$(jq -r '.height' "$json_file")
        weight=$(jq -r '.weight' "$json_file")

        # Convert units using awk and format to 2 decimals for CSV
        height_m=$(awk "BEGIN{printf \"%.2f\", $height/10}")
        weight_kg=$(awk "BEGIN{printf \"%.2f\", $weight/10}")

        echo "${name},${height_m},${weight_kg}" >> "$REPORT_FILE"
    fi
done

# Normalize formatting with sed (ensure leading dot becomes leading 0, e.g. .70 -> 0.70)
sed -i 's/,\./,0./g' "$REPORT_FILE"

# Calculate averages using awk
avg_height=$(awk -F, 'NR>1{h+=$2; c++} END{if(c>0) printf "%.2f", h/c; else print "0.00"}' "$REPORT_FILE")
avg_weight=$(awk -F, 'NR>1{w+=$3; c++} END{if(c>0) printf "%.2f", w/c; else print "0.00"}' "$REPORT_FILE")

echo "CSV Report generated at: $REPORT_FILE"
echo ""
cat "$REPORT_FILE"
echo ""
echo "Average Height: $avg_height m"
echo "Average Weight: $avg_weight kg"
